stages:
  - build
  - test

variables:
  # Node.js version
  NODE_VERSION: "20.19.3"
  # Working directory
  FRONTEND_DIR: "frontend"

# Cache node_modules for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ${FRONTEND_DIR}/node_modules/
    - ${FRONTEND_DIR}/.npm/

before_script:
  - echo "Building Natpudan AI Medical Assistant"
  - echo "Node version:" && node --version
  - echo "npm version:" && npm --version
  - cd ${FRONTEND_DIR}

# Build Web Application
build:web:
  stage: build
  image: node:20-alpine
  script:
    - echo "Installing dependencies..."
    - npm ci --cache .npm --prefer-offline
    - echo "Building web application..."
    - npm run build:web
  artifacts:
    paths:
      - ${FRONTEND_DIR}/dist/
    expire_in: 1 week
  only:
    - clean-main2
    - main
    - merge_requests

# Build Android APK (requires Android SDK)
build:android:
  stage: build
  image: 319312831725.dkr.ecr.us-west-2.amazonaws.com/appflow-runners/linux:2025.06
  variables:
    # Set Android SDK paths for the Ionic Appflow runner
    ANDROID_HOME: "/usr/local/android-sdk"
    ANDROID_SDK_ROOT: "/usr/local/android-sdk"
    # Alternative paths if using different Android SDK installation
    # ANDROID_HOME: "/opt/android-sdk"
    # ANDROID_SDK_ROOT: "/opt/android-sdk"
  script:
    - echo "Setting up Android environment..."
    - echo "ANDROID_HOME=${ANDROID_HOME}"
    - echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}"
    # Verify Android SDK is available
    - |
      if [ -d "$ANDROID_HOME" ]; then
        echo "✓ Android SDK found at $ANDROID_HOME"
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin
      else
        echo "⚠ Android SDK not found at $ANDROID_HOME"
        echo "Checking common Android SDK locations..."
        for dir in /usr/local/android-sdk /opt/android-sdk /android-sdk ~/Android/Sdk; do
          if [ -d "$dir" ]; then
            echo "✓ Found Android SDK at $dir"
            export ANDROID_HOME=$dir
            export ANDROID_SDK_ROOT=$dir
            export PATH=$PATH:$dir/tools:$dir/platform-tools:$dir/cmdline-tools/latest/bin
            break
          fi
        done
      fi
    - echo "PATH=$PATH"
    - echo "Installing dependencies..."
    - npm ci --cache .npm --prefer-offline
    - echo "Building web assets..."
    - npm run build:web
    - echo "Initializing Capacitor..."
    - npx cap init "Natpudan AI" "com.natpudan.medical" --web-dir=dist || echo "Capacitor already initialized"
    - echo "Adding Android platform..."
    - npx cap add android || echo "Android platform already added"
    - echo "Syncing web assets to Android..."
    - npx cap sync android
    - echo "Building Android APK..."
    - cd android
    - chmod +x ./gradlew
    - ./gradlew assembleRelease || echo "Android build requires signing configuration"
  artifacts:
    paths:
      - ${FRONTEND_DIR}/android/app/build/outputs/apk/
      - ${FRONTEND_DIR}/android/app/build/outputs/bundle/
    expire_in: 1 week
  only:
    - clean-main2
    - main
  allow_failure: true # Allow to fail if Android SDK not configured or signing missing

# Build Windows Desktop App
build:windows:
  stage: build
  image: electronuserland/builder:wine
  script:
    - echo "Installing dependencies..."
    - npm ci --cache .npm --prefer-offline
    - echo "Building web assets..."
    - npm run build:web
    - echo "Building Windows desktop app..."
    - npm run electron:build -- --windows
  artifacts:
    paths:
      - ${FRONTEND_DIR}/release/
    expire_in: 1 week
  only:
    - clean-main2
    - main
  allow_failure: true # Allow to fail if not on Windows runner

# Lint and Type Check
lint:
  stage: test
  image: node:20-alpine
  script:
    - echo "Running linter..."
    - npm ci --cache .npm --prefer-offline
    - npm run lint || echo "No lint script found"
  only:
    - merge_requests
  allow_failure: true

# Run Tests
test:
  stage: test
  image: node:20-alpine
  script:
    - echo "Running tests..."
    - npm ci --cache .npm --prefer-offline
    - npm test || echo "No test script found"
  only:
    - merge_requests
  allow_failure: true

# Deploy to Staging (when merged to clean-main2)
deploy:staging:
  stage: build
  image: node:20-alpine
  script:
    - echo "Deploying to staging environment..."
    - echo "Web app built successfully at ${FRONTEND_DIR}/dist/"
    - echo "Ready for deployment to your hosting provider"
  dependencies:
    - build:web
  only:
    - clean-main2
  when: manual

# Deploy to Production (when merged to main)
deploy:production:
  stage: build
  image: node:20-alpine
  script:
    - echo "Deploying to production environment..."
    - echo "Web app built successfully at ${FRONTEND_DIR}/dist/"
    - echo "Ready for deployment to your hosting provider"
  dependencies:
    - build:web
  only:
    - main
  when: manual
